<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸æ“‡åº§ä½ - å¨å®‡å½±åŸ</title>
    <link rel="stylesheet" href="/WeiYuCinema/static/css/style.css">
</head>
<body>
    <!-- é é¦–ä½”ä½ç¬¦ -->
    <div id="header-placeholder"></div>
    
    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container">
        <div class="page-title">
            <h1>é¸æ“‡åº§ä½</h1>
            <p>è«‹é¸æ“‡æ‚¨çš„åº§ä½</p>
        </div>
        
        <!-- å ´æ¬¡è³‡è¨Š -->
        <div class="section-box">
            <div class="showing-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: center;">
                    <div>
                        <h3 style="margin: 0 0 10px 0; font-size: 24px;"><?php echo htmlspecialchars($showing['movieName']); ?></h3>
                        <p style="margin: 0; opacity: 0.9;"><?php echo htmlspecialchars($showing['cinemaName']); ?> - <?php echo htmlspecialchars($showing['theaterName']); ?></p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">æ”¾æ˜ æ™‚é–“</div>
                        <div style="font-size: 20px; font-weight: bold;">
                            <?php echo date('m/d H:i', strtotime($showing['showDate'] . ' ' . $showing['showTime'])); ?>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">ç¥¨åƒ¹</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                            NT$ <?php echo number_format($ticketPrice); ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åº§ä½åœ–ä¾‹ -->
        <div class="section-box">
            <h3 class="section-title">ğŸ­ åº§ä½åœ–ä¾‹</h3>
            <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="seat available" style="width: 30px; height: 30px; background: #28a745; border: 2px solid #229954; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">A1</div>
                    <span>å¯é¸åº§ä½</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="seat selected" style="width: 30px; height: 30px; background: var(--primary-color); border: 2px solid #e0a800; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #000; font-size: 12px; font-weight: bold;">B2</div>
                    <span>å·²é¸åº§ä½</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="seat occupied" style="width: 30px; height: 30px; background: #dc3545; border: 2px solid #c82333; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">C3</div>
                    <span>å·²å”®å‡º</span>
                </div>
            </div>
        </div>
        
        <!-- åº§ä½é¸æ“‡å€åŸŸ -->
        <div class="section-box">
            <h3 class="section-title">ğŸ¬ éŠ€å¹•</h3>
            
            <!-- éŠ€å¹• -->
            <div class="screen" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; text-align: center; padding: 15px; margin: 0 auto 40px auto; border-radius: 50px; width: 80%; position: relative;">
                <div style="font-size: 18px; font-weight: bold;">ğŸ¬ SCREEN éŠ€å¹• ğŸ¬</div>
                <div style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 20px solid #34495e;"></div>
            </div>
            
            <!-- åº§ä½åœ°åœ– -->
            <div class="seat-map" style="background: #1a1a1a; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                <?php
                $currentRow = '';
                $seatCount = 0;
                ?>
                
                <?php foreach ($seats as $seat): ?>
                    <?php
                    $row = substr($seat['seatNumber'], 0, 1);
                    if ($row !== $currentRow) {
                        if ($currentRow !== '') {
                            echo '</div>'; // çµæŸå‰ä¸€è¡Œ
                        }
                        echo '<div class="seat-row" style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center; justify-content: center;">';
                        echo '<div class="row-label" style="width: 40px; text-align: center; font-weight: bold; font-size: 16px; color: var(--primary-color);">' . $row . '</div>';
                        $currentRow = $row;
                    }
                    
                    $seatClass = 'available';
                    $clickable = 'true';
                    if ($seat['seatEmpty'] == 0) {
                        $seatClass = 'occupied';
                        $clickable = 'false';
                    }
                    ?>
                    
                    <div class="seat <?php echo $seatClass; ?>" 
                         data-seat="<?php echo htmlspecialchars($seat['seatNumber']); ?>"
                         data-clickable="<?php echo $clickable; ?>"
                         style="width: 35px; height: 35px; border: 2px solid; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: <?php echo $seatClass === 'available' ? 'pointer' : 'not-allowed'; ?>; font-size: 12px; font-weight: bold; transition: all 0.3s; <?php echo $seatClass === 'available' ? 'background: #28a745; border-color: #229954; color: white;' : 'background: #dc3545; border-color: #c82333; color: white; opacity: 0.6;'; ?>">
                        <?php echo htmlspecialchars(substr($seat['seatNumber'], 1)); ?>
                    </div>
                <?php endforeach; ?>
                
                <?php if ($currentRow !== ''): ?>
                    </div> <!-- çµæŸæœ€å¾Œä¸€è¡Œ -->
                <?php endif; ?>
            </div>
            
            <!-- é¸åº§èªªæ˜ -->
            <div style="text-align: center; color: var(--text-muted); margin-bottom: 30px;">
                <p>ğŸ’¡ æç¤ºï¼šé»æ“Šç¶ è‰²åº§ä½é€²è¡Œé¸æ“‡ï¼Œæœ€å¤šå¯é¸æ“‡ 8 å€‹åº§ä½</p>
            </div>
        </div>
        
        <!-- è¨‚ç¥¨æ‘˜è¦ -->
        <div class="section-box">
            <h3 class="section-title">ğŸ“‹ è¨‚ç¥¨æ‘˜è¦</h3>
            <div style="background: #2c2c2c; padding: 25px; border-radius: 12px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <div style="color: var(--text-muted); font-size: 14px; margin-bottom: 5px;">å·²é¸åº§ä½</div>
                        <div id="selectedSeats" style="font-size: 18px; font-weight: bold; color: var(--primary-color);">å°šæœªé¸æ“‡</div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 14px; margin-bottom: 5px;">ç¥¨æ•¸</div>
                        <div id="ticketCount" style="font-size: 18px; font-weight: bold;">0</div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 14px; margin-bottom: 5px;">å–®åƒ¹</div>
                        <div style="font-size: 18px; font-weight: bold;">NT$ <?php echo number_format($ticketPrice); ?></div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 14px; margin-bottom: 5px;">ç¸½é‡‘é¡</div>
                        <div id="totalPrice" style="font-size: 24px; font-weight: bold; color: var(--primary-color);">NT$ 0</div>
                    </div>
                </div>
                
                <form action="select_meal.php" method="POST" id="seatForm">
                    <input type="hidden" name="showingId" value="<?php echo htmlspecialchars($showingId); ?>">
                    <input type="hidden" name="selectedSeats" id="selectedSeatsInput">
                    <input type="hidden" name="ticketCount" id="ticketCountInput">
                    <input type="hidden" name="totalPrice" id="totalPriceInput">
                    
                    <div class="text-center">
                        <button type="submit" id="nextBtn" class="btn btn-primary" disabled style="padding: 15px 40px; font-size: 18px;">
                            ä¸‹ä¸€æ­¥ï¼šé¸æ“‡é¤é» â†’
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- è¿”å›æŒ‰éˆ• -->
        <div class="text-center" style="margin-top: 40px;">
            <a href="booking.php" class="btn btn-secondary" style="padding: 15px 30px; font-size: 16px;">
                â† é‡æ–°é¸æ“‡å ´æ¬¡
            </a>
        </div>
    </div>
    
    <!-- é å°¾ä½”ä½ç¬¦ -->
    <div id="footer-placeholder"></div>
    
    <!-- è¼‰å…¥æ ¸å¿ƒJavaScript -->
    <script src="/WeiYuCinema/static/js/script.js"></script>
    
    <script>
        // åˆå§‹åŒ–åº§ä½é¸æ“‡åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const ticketPrice = <?php echo $ticketPrice; ?>;
            
            // ä½¿ç”¨å…¨åŸŸå‡½æ•¸åˆå§‹åŒ–åº§ä½é¸æ“‡
            if (typeof window.initSeatSelection === 'function') {
                window.initSeatSelection(ticketPrice);
            } else {
                // å‚™ç”¨åº§ä½é¸æ“‡é‚è¼¯
                let selectedSeats = [];
                const maxSeats = 8;
                
                document.querySelectorAll('.seat.available').forEach(seat => {
                    seat.addEventListener('click', function() {
                        const seatId = this.dataset.seat;
                        
                        if (this.classList.contains('selected')) {
                            // å–æ¶ˆé¸æ“‡
                            this.classList.remove('selected');
                            this.style.background = '#28a745';
                            this.style.borderColor = '#229954';
                            this.style.color = 'white';
                            this.style.transform = 'scale(1)';
                            this.style.boxShadow = 'none';
                            selectedSeats = selectedSeats.filter(s => s !== seatId);
                        } else {
                            // æª¢æŸ¥æ˜¯å¦è¶…éæœ€å¤§åº§ä½æ•¸
                            if (selectedSeats.length >= maxSeats) {
                                showNotification('æœ€å¤šåªèƒ½é¸æ“‡ ' + maxSeats + ' å€‹åº§ä½', 'warning');
                                return;
                            }
                            
                            // é¸æ“‡åº§ä½
                            this.classList.add('selected');
                            this.style.background = 'var(--primary-color)';
                            this.style.borderColor = '#e0a800';
                            this.style.color = '#000';
                            this.style.transform = 'scale(1.1)';
                            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
                            selectedSeats.push(seatId);
                        }
                        
                        updateBookingSummary();
                    });
                });
                
                function updateBookingSummary() {
                    const ticketCount = selectedSeats.length;
                    const totalPrice = ticketCount * ticketPrice;
                    
                    document.getElementById('selectedSeats').textContent = selectedSeats.length > 0 ? selectedSeats.sort().join(', ') : 'å°šæœªé¸æ“‡';
                    document.getElementById('ticketCount').textContent = ticketCount;
                    document.getElementById('totalPrice').textContent = 'NT$ ' + totalPrice.toLocaleString();
                    
                    // æ›´æ–°éš±è—æ¬„ä½
                    document.getElementById('selectedSeatsInput').value = selectedSeats.join(',');
                    document.getElementById('ticketCountInput').value = ticketCount;
                    document.getElementById('totalPriceInput').value = totalPrice;
                    
                    // å•Ÿç”¨/ç¦ç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
                    const nextBtn = document.getElementById('nextBtn');
                    nextBtn.disabled = ticketCount === 0;
                    
                    if (ticketCount > 0) {
                        nextBtn.style.opacity = '1';
                        nextBtn.style.cursor = 'pointer';
                    } else {
                        nextBtn.style.opacity = '0.6';
                        nextBtn.style.cursor = 'not-allowed';
                    }
                }
            }
        });
    </script>
</body>
</html>