<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改訂票 - 威宇影城售票系統</title>
    <link rel="stylesheet" href="/WeiYuCinema/static/css/style.css">
</head>
<body>
    <!-- 頁首佔位符 -->
    <div id="header-placeholder"></div>

    <!-- 主要內容 -->
    <div class="container">
        <div class="page-title">
            <h1>✏️ 修改訂票</h1>
            <p>訂單編號：<?php echo htmlspecialchars($record['orderNumber']); ?></p>
        </div>

        <!-- 訂單資訊 -->
        <div class="section-box">
            <h2 class="section-title">📋 訂單資訊</h2>
            <div class="order-summary">
                <div class="info-grid">
                    <div class="info-item">
                        <strong>電影：</strong>
                        <span><?php echo htmlspecialchars($record['movieName']); ?></span>
                    </div>
                    <div class="info-item">
                        <strong>影城：</strong>
                        <span><?php echo htmlspecialchars($record['cinemaName']); ?></span>
                    </div>
                    <div class="info-item">
                        <strong>影廳：</strong>
                        <span><?php echo htmlspecialchars($record['theaterName']); ?></span>
                    </div>
                    <div class="info-item">
                        <strong>場次：</strong>
                        <span><?php echo $record['showingDate']; ?> <?php echo $record['startTime']; ?></span>
                    </div>
                    <div class="info-item">
                        <strong>目前座位：</strong>
                        <span class="current-seats">
                            <?php foreach ($currentSeats as $seat): ?>
                            <span class="seat-tag"><?php echo htmlspecialchars($seat); ?></span>
                            <?php endforeach; ?>
                        </span>
                    </div>
                    <div class="info-item">
                        <strong>票數：</strong>
                        <span><?php echo $record['ticketNums']; ?> 張</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 座位修改 -->
        <div class="section-box">
            <h2 class="section-title">💺 座位修改</h2>
            
            <?php if (!$canChange): ?>
            <div class="message error">
                <p>❌ <?php echo $changeMessage; ?></p>
                <div class="form-actions">
                    <a href="detail.php?orderNumber=<?php echo urlencode($orderNumber); ?>" class="btn btn-secondary">返回詳情</a>
                    <a href="index.php" class="btn btn-primary">返回列表</a>
                </div>
            </div>
            <?php else: ?>
            
            <?php if (!empty($changeMessage)): ?>
            <div class="message error">
                <?php echo $changeMessage; ?>
            </div>
            <?php endif; ?>
            
            <div class="change-notice">
                <h3>⚠️ 修改須知</h3>
                <ul>
                    <li>修改訂票必須在電影開演前2小時完成</li>
                    <li>只能修改座位，不能更改場次或票數</li>
                    <li>新選擇的座位數量必須與原訂票數量相同</li>
                    <li>修改後無法復原，請謹慎選擇</li>
                </ul>
            </div>
            
            <form method="POST" class="change-form">
                <div class="seat-selection">
                    <h3>請選擇新座位 (需選擇 <?php echo $record['ticketNums']; ?> 個座位)</h3>
                    
                    <div class="seat-legend">
                        <div class="legend-item">
                            <span class="seat-demo available"></span>
                            <span>可選座位</span>
                        </div>
                        <div class="legend-item">
                            <span class="seat-demo occupied"></span>
                            <span>已被佔用</span>
                        </div>
                        <div class="legend-item">
                            <span class="seat-demo current"></span>
                            <span>目前座位</span>
                        </div>
                        <div class="legend-item">
                            <span class="seat-demo selected"></span>
                            <span>新選座位</span>
                        </div>
                    </div>
                    
                    <div class="seat-map">
                        <div class="screen">螢幕</div>
                        <div class="seats-container">
                            <?php
                            // 生成座位圖 (簡化版，假設5排10列)
                            $rows = ['A', 'B', 'C', 'D', 'E'];
                            $cols = range(1, 10);
                            
                            foreach ($rows as $row):
                            ?>
                            <div class="seat-row">
                                <span class="row-label"><?php echo $row; ?></span>
                                <?php foreach ($cols as $col):
                                    $seatNumber = $row . $col;
                                    $seatClass = 'seat';
                                    $isDisabled = false;
                                    
                                    if (in_array($seatNumber, $currentSeats)) {
                                        $seatClass .= ' current';
                                    } elseif (in_array($seatNumber, $occupiedSeats)) {
                                        $seatClass .= ' occupied';
                                        $isDisabled = true;
                                    } elseif (in_array($seatNumber, $availableSeats)) {
                                        $seatClass .= ' available';
                                    } else {
                                        $seatClass .= ' unavailable';
                                        $isDisabled = true;
                                    }
                                ?>
                                <label class="<?php echo $seatClass; ?>">
                                    <input type="checkbox" name="seats[]" value="<?php echo $seatNumber; ?>" 
                                           <?php echo $isDisabled ? 'disabled' : ''; ?>
                                           <?php echo in_array($seatNumber, $currentSeats) ? 'checked' : ''; ?>>
                                    <span class="seat-number"><?php echo $col; ?></span>
                                </label>
                                <?php endforeach; ?>
                            </div>
                            <?php endforeach; ?>
                        </div>
                    </div>
                    
                    <div class="selected-seats">
                        <h4>已選座位：<span id="selected-count">0</span> / <?php echo $record['ticketNums']; ?></h4>
                        <div id="selected-seats-display"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submit-btn" disabled
                            onclick="return confirm('確定要修改座位嗎？')">
                        ✏️ 確認修改
                    </button>
                    <a href="detail.php?orderNumber=<?php echo urlencode($orderNumber); ?>" 
                       class="btn btn-secondary">取消</a>
                </div>
            </form>
            <?php endif; ?>
        </div>
    </div>

    <!-- 頁尾佔位符 -->
    <div id="footer-placeholder"></div>

    <!-- 載入核心JavaScript -->
    <script src="/WeiYuCinema/static/js/script.js"></script>
    
    <?php if ($canChange): ?>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const requiredSeats = <?php echo $record['ticketNums']; ?>;
        const checkboxes = document.querySelectorAll('input[name="seats[]"]:not([disabled])');
        const selectedCountEl = document.getElementById('selected-count');
        const selectedSeatsDisplay = document.getElementById('selected-seats-display');
        const submitBtn = document.getElementById('submit-btn');
        
        function updateSeatSelection() {
            const selected = document.querySelectorAll('input[name="seats[]"]:checked');
            const selectedSeats = Array.from(selected).map(cb => cb.value);
            
            selectedCountEl.textContent = selected.length;
            selectedSeatsDisplay.innerHTML = selectedSeats.map(seat => 
                `<span class="seat-tag">${seat}</span>`
            ).join('');
            
            // 更新座位樣式
            checkboxes.forEach(cb => {
                const label = cb.parentElement;
                if (cb.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
            });
            
            // 控制提交按鈕
            submitBtn.disabled = selected.length !== requiredSeats;
        }
        
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSeatSelection);
        });
        
        // 初始化
        updateSeatSelection();
    });
    </script>
    <?php endif; ?>
</body>
</html>
