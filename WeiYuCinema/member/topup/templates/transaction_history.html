<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易紀錄查詢 - 威宇影城</title>
    <link rel="stylesheet" href="/WeiYuCinema/static/css/style.css">
</head>
<body>
    <!-- 頁首佔位符 -->
    <div id="header-placeholder"></div>
    
    <!-- 主要內容 -->
    <div class="container">
        <div class="page-title">
            <h1>交易紀錄查詢</h1>
            <p>查看您的儲值卡完整交易記錄</p>
        </div>
        
        <!-- 篩選功能 -->
        <div class="section-box">
            <h2 class="section-title">🔍 篩選條件</h2>
            <form method="GET" action="">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="type">交易類型</label>
                        <select id="type" name="type">
                            <option value="">全部類型</option>
                            <option value="TOPUP" <?php echo ($filterType === 'TOPUP') ? 'selected' : ''; ?>>儲值</option>
                            <option value="CONSUME" <?php echo ($filterType === 'CONSUME') ? 'selected' : ''; ?>>消費</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="startDate">開始日期</label>
                        <input type="date" id="startDate" name="startDate" value="<?php echo htmlspecialchars($startDate); ?>">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate">結束日期</label>
                        <input type="date" id="endDate" name="endDate" value="<?php echo htmlspecialchars($endDate); ?>">
                    </div>
                    
                    <div class="form-group">
                        <label for="minAmount">最小金額</label>
                        <input type="number" id="minAmount" name="minAmount" min="0" placeholder="0" value="<?php echo htmlspecialchars($minAmount); ?>">
                    </div>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary" style="margin-right: 10px;">🔍 查詢</button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">清除條件</button>
                </div>
            </form>
        </div>
        
        <!-- 交易統計 -->
        <?php if (!empty($summary)): ?>
        <div class="section-box">
            <h2 class="section-title">📊 交易統計</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 10px;">💰</div>
                    <h3 style="margin: 0; font-size: 18px;">總儲值</h3>
                    <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold;">NT$ <?php echo number_format($summary['totalTopup']); ?></p>
                    <small style="opacity: 0.8;"><?php echo $summary['topupCount']; ?> 筆交易</small>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 10px;">🎟️</div>
                    <h3 style="margin: 0; font-size: 18px;">總消費</h3>
                    <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold;">NT$ <?php echo number_format($summary['totalConsume']); ?></p>
                    <small style="opacity: 0.8;"><?php echo $summary['consumeCount']; ?> 筆交易</small>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 10px;">📈</div>
                    <h3 style="margin: 0; font-size: 18px;">淨額</h3>
                    <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold;">NT$ <?php echo number_format($summary['totalTopup'] - $summary['totalConsume']); ?></p>
                    <small style="opacity: 0.8;">儲值 - 消費</small>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6610f2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 10px;">💳</div>
                    <h3 style="margin: 0; font-size: 18px;">目前餘額</h3>
                    <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold;">NT$ <?php echo number_format($currentBalance); ?></p>
                    <small style="opacity: 0.8;">可用餘額</small>
                </div>
            </div>
        </div>
        <?php endif; ?>
        
        <!-- 交易記錄列表 -->
        <div class="section-box">
            <h2 class="section-title">📋 交易記錄 (共 <?php echo $totalRecords; ?> 筆)</h2>
            
            <?php if (!empty($transactions)): ?>
                <div class="transaction-list">
                    <?php foreach ($transactions as $transaction): ?>
                        <div class="transaction-item" style="background: #2c2c2c; border-radius: 12px; padding: 25px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 20px; align-items: center;">
                                <!-- 交易類型圖示 -->
                                <div class="transaction-icon" style="font-size: 32px;">
                                    <?php if ($transaction['transactionType'] === 'TOPUP'): ?>
                                        💰
                                    <?php else: ?>
                                        🎟️
                                    <?php endif; ?>
                                </div>
                                
                                <!-- 交易資訊 -->
                                <div class="transaction-details">
                                    <div class="transaction-type" style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">
                                        <?php if ($transaction['transactionType'] === 'TOPUP'): ?>
                                            <span style="color: #28a745;">儲值交易</span>
                                        <?php else: ?>
                                            <span style="color: #dc3545;">消費交易</span>
                                        <?php endif; ?>
                                    </div>
                                    <div class="transaction-desc" style="color: var(--text-muted); margin-bottom: 5px;">
                                        <?php echo htmlspecialchars($transaction['description']); ?>
                                    </div>
                                    <div class="transaction-id" style="font-size: 12px; color: var(--text-muted);">
                                        交易編號: <?php echo htmlspecialchars($transaction['transactionId']); ?>
                                    </div>
                                </div>
                                
                                <!-- 金額 -->
                                <div class="transaction-amount" style="text-align: right;">
                                    <div class="amount" style="font-size: 20px; font-weight: bold; <?php echo $transaction['transactionType'] === 'TOPUP' ? 'color: #28a745;' : 'color: #dc3545;'; ?>">
                                        <?php echo $transaction['transactionType'] === 'TOPUP' ? '+' : '-'; ?>NT$ <?php echo number_format($transaction['amount']); ?>
                                    </div>
                                    <div class="balance-change" style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
                                        <?php echo number_format($transaction['balanceBefore']); ?> → <?php echo number_format($transaction['balanceAfter']); ?>
                                    </div>
                                </div>
                                
                                <!-- 日期時間 -->
                                <div class="transaction-date" style="text-align: right; color: var(--text-muted);">
                                    <div style="font-size: 14px; font-weight: bold;">
                                        <?php echo date('m/d', strtotime($transaction['transactionDate'])); ?>
                                    </div>
                                    <div style="font-size: 12px;">
                                        <?php echo date('H:i', strtotime($transaction['transactionDate'])); ?>
                                    </div>
                                    <div style="font-size: 10px; margin-top: 2px;">
                                        <?php echo date('Y', strtotime($transaction['transactionDate'])); ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
                
                <!-- 分頁導覽 -->
                <?php if ($totalPages > 1): ?>
                <div class="pagination" style="text-align: center; margin-top: 40px;">
                    <?php
                    $currentUrl = $_SERVER['REQUEST_URI'];
                    $urlParts = parse_url($currentUrl);
                    parse_str($urlParts['query'] ?? '', $queryParams);
                    ?>
                    
                    <?php if ($currentPage > 1): ?>
                        <?php
                        $queryParams['page'] = $currentPage - 1;
                        $prevUrl = '?' . http_build_query($queryParams);
                        ?>
                        <a href="<?php echo $prevUrl; ?>" class="btn btn-secondary" style="margin: 0 5px;">← 上一頁</a>
                    <?php endif; ?>
                    
                    <span style="margin: 0 15px; color: var(--text-muted);">
                        第 <?php echo $currentPage; ?> 頁，共 <?php echo $totalPages; ?> 頁
                    </span>
                    
                    <?php if ($currentPage < $totalPages): ?>
                        <?php
                        $queryParams['page'] = $currentPage + 1;
                        $nextUrl = '?' . http_build_query($queryParams);
                        ?>
                        <a href="<?php echo $nextUrl; ?>" class="btn btn-secondary" style="margin: 0 5px;">下一頁 →</a>
                    <?php endif; ?>
                </div>
                <?php endif; ?>
                
            <?php else: ?>
                <div class="text-center" style="padding: 60px 20px;">
                    <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">📋</div>
                    <h3 class="text-muted">沒有找到交易記錄</h3>
                    <p class="text-muted">請調整篩選條件或開始您的第一次交易</p>
                    <a href="index.php" class="btn btn-primary" style="margin-top: 20px;">
                        💰 立即儲值
                    </a>
                </div>
            <?php endif; ?>
        </div>
        
        <!-- 返回按鈕 -->
        <div class="text-center" style="margin-top: 40px;">
            <a href="index.php" class="btn btn-secondary" style="padding: 15px 30px; font-size: 16px;">
                ← 返回儲值卡管理
            </a>
        </div>
    </div>
    
    <!-- 頁尾佔位符 -->
    <div id="footer-placeholder"></div>
    
    <!-- 載入核心JavaScript -->
    <script src="/WeiYuCinema/static/js/script.js"></script>
    
    <script>
        // 清除篩選條件
        function clearFilters() {
            document.getElementById('type').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('minAmount').value = '';
            
            // 重新載入頁面
            window.location.href = window.location.pathname;
        }
        
        // 日期範圍驗證
        document.addEventListener('DOMContentLoaded', function() {
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            function validateDateRange() {
                if (startDate.value && endDate.value) {
                    if (new Date(startDate.value) > new Date(endDate.value)) {
                        endDate.setCustomValidity('結束日期不能早於開始日期');
                    } else {
                        endDate.setCustomValidity('');
                    }
                }
            }
            
            startDate.addEventListener('change', validateDateRange);
            endDate.addEventListener('change', validateDateRange);
        });
    </script>
</body>
</html>