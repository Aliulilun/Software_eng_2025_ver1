# 🎬 購票服務系統 (Booking System)

## 📋 功能概述

購票服務系統是威宇影城售票系統的核心功能，提供完整的線上訂票流程，從場次選擇到付款完成的一站式服務。

---

## ✨ 主要功能

### 1. **場次選擇 (booking.php)**
- 🎭 顯示所有可用電影場次
- 🔍 支援電影、影城、日期篩選
- 📅 只顯示今天及以後的場次
- 💰 顯示票價資訊

### 2. **座位選擇 (select_seat.php)**
- 💺 視覺化座位圖
- 🎯 即時座位狀態顯示
- ✅ 多座位選擇（最多8個）
- 💵 即時價格計算

### 3. **餐點選擇 (select_meal.php)**
- 🍿 分類餐點展示
- 🛒 數量選擇功能
- 💰 即時小計計算
- 📋 訂單摘要顯示

### 4. **訂單確認 (confirm.php)**
- 📋 完整訂單資訊
- 💳 餘額檢查
- 🚫 座位可用性驗證
- ⚠️ 錯誤提示處理

### 5. **付款處理 (process.php)**
- 💳 資料庫交易處理
- 🔒 座位鎖定機制
- 💰 餘額扣款
- 📝 交易記錄

### 6. **訂票成功 (success.php)**
- 🎉 成功確認頁面
- 🎫 取票號碼顯示
- 📋 完整訂單詳情
- 🔗 後續操作連結

---

## 🗂️ 檔案結構

```
member/booking/
├── booking.php                    # 場次選擇主頁面
├── select_seat.php               # 座位選擇頁面
├── select_meal.php               # 餐點選擇頁面
├── confirm.php                   # 訂單確認頁面
├── process.php                   # 付款處理後端
├── success.php                   # 訂票成功頁面
└── templates/                    # HTML模板目錄
    ├── booking.html              # 場次選擇模板
    ├── select_seat.html          # 座位選擇模板
    ├── select_meal.html          # 餐點選擇模板
    ├── confirm.html              # 訂單確認模板
    └── success.html              # 成功頁面模板
```

---

## 🔧 技術特色

### 安全性
- 🔒 **交易安全**：使用資料庫交易確保數據一致性
- 🛡️ **SQL防護**：所有查詢使用prepared statements
- ✨ **XSS防護**：輸出使用htmlspecialchars處理
- 🚫 **重複提交防護**：防止重複訂票

### 使用者體驗
- 📱 **響應式設計**：支援桌面和手機版本
- 🎨 **現代化介面**：美觀的視覺設計和動畫效果
- ⚡ **即時反饋**：座位選擇和價格計算即時更新
- 🔄 **流程導航**：清晰的步驟指示

### 資料處理
- 🔄 **即時驗證**：座位可用性和餘額檢查
- 📊 **完整記錄**：訂單、交易、座位狀態同步更新
- 🎯 **錯誤處理**：完善的錯誤提示和回滾機制

---

## 📊 資料庫設計

### 主要資料表

| 資料表 | 用途 | 關鍵欄位 |
|--------|------|----------|
| `showing` | 場次資訊 | showingId, movieId, theaterId, showingDate, startTime |
| `seatCondition` | 座位狀態 | showingId, seatNumber, seatEmpty |
| `bookingRecord` | 訂票記錄 | orderNumber, memberId, showingId, seat, totalPrice |
| `memberCashCard` | 會員餘額 | memberId, balance |
| `topupTransaction` | 交易記錄 | transactionId, memberId, transactionType, amount |
| `meals` | 餐點資訊 | mealsId, mealsName, mealsPrice |

### 資料流程
1. **場次查詢** → `showing` + `movie` + `cinema` + `theater`
2. **座位檢查** → `seatCondition`
3. **餐點選擇** → `meals` + `mealsType`
4. **訂單建立** → `bookingRecord`
5. **座位更新** → `seatCondition` (seatEmpty = 0)
6. **餘額扣款** → `memberCashCard`
7. **交易記錄** → `topupTransaction`

---

## 🚀 使用流程

### 1. **存取購票頁面**
```
http://localhost/WeiYuCinema/member/booking/booking.php
```

### 2. **完整購票流程**
1. **選擇場次** → 篩選電影、影城、日期
2. **選擇座位** → 點選可用座位（綠色）
3. **選擇餐點** → 可選，使用 +/- 按鈕調整數量
4. **確認訂單** → 檢查資訊和餘額
5. **完成付款** → 系統處理交易
6. **取得票券** → 顯示取票號碼

### 3. **座位圖說明**
- 🟢 **綠色**：可選座位
- 🟡 **黃色**：已選座位
- 🔴 **紅色**：已售座位
- 📺 **螢幕**：影廳前方

---

## 🧪 測試資料

### 測試帳號
```
帳號：ming123@gmail.com
密碼：pw1234
餘額：NT$ 1,410
```

### 測試場次
- **復仇者聯盟**：2025-12-05 多個時段
- **阿凡達**：2025-12-06 多個時段  
- **鐵達尼號**：2025-12-07 多個時段

### 測試餐點
- **爆米花類**：大/中/小爆米花、焦糖爆米花
- **飲料類**：可樂、雪碧、柳橙汁
- **套餐類**：單人/雙人/情侶套餐

---

## ⚠️ 重要注意事項

### 業務規則
1. **座位限制**：每次最多選擇8個座位
2. **時間限制**：只能預訂今天及以後的場次
3. **餘額要求**：必須有足夠餘額才能完成訂票
4. **座位鎖定**：選擇的座位在交易過程中會被鎖定

### 錯誤處理
- **座位已售**：自動返回重新選擇
- **餘額不足**：提示前往儲值
- **系統錯誤**：交易回滾，保持數據一致性
- **重複提交**：防護機制避免重複扣款

### 效能考量
- **資料庫索引**：showingId, memberId 等關鍵欄位
- **交易優化**：批次處理座位更新
- **快取機制**：場次和餐點資料可考慮快取

---

## 🔗 相關功能連結

- **會員首頁**：`../index.php`
- **瀏覽電影**：`../browse/movies.php`
- **訂票紀錄**：`../inquiry/index.php`
- **儲值卡**：`../topup/index.php`
- **會員資料**：`../profile/profile.php`

---

## 📈 未來擴展

### 功能增強
1. **座位推薦**：智能推薦最佳座位
2. **團體訂票**：支援大量座位預訂
3. **優惠券**：折扣碼和促銷活動
4. **會員等級**：VIP會員專屬優惠

### 技術改進
1. **即時通知**：WebSocket 即時座位狀態
2. **支付整合**：第三方支付平台
3. **行動支付**：手機支付功能
4. **API介面**：RESTful API 支援

---

## 🐛 故障排除

### 常見問題

| 問題 | 原因 | 解決方法 |
|------|------|----------|
| 座位圖不顯示 | 資料庫連接問題 | 檢查 db_connect.php |
| 餘額顯示錯誤 | memberCashCard 資料缺失 | 執行 add_topup_test_data.sql |
| 場次不顯示 | 日期篩選問題 | 確認場次日期 >= 今天 |
| 訂票失敗 | 交易衝突 | 檢查資料庫交易設定 |

### 除錯步驟
1. **檢查資料庫連接**
2. **確認測試資料完整性**
3. **查看 PHP 錯誤日誌**
4. **驗證 session 狀態**
5. **測試交易回滾機制**

---

**版本：** 1.0  
**更新日期：** 2025-12-04  
**功能狀態：** ✅ Booking (B) 功能已完成  
**開發者：** 威宇影城開發團隊

---

## 🎯 快速測試

### 測試清單
- [ ] 場次篩選功能
- [ ] 座位選擇互動
- [ ] 餐點數量調整
- [ ] 餘額不足提示
- [ ] 座位衝突處理
- [ ] 訂票成功流程
- [ ] 取票號碼生成
- [ ] 交易記錄正確性

**購票系統已完整實作，可開始測試使用！** 🎬🎉
